@page
@model IndexModel
@using TNTCalculatorRazor.Domain.Enums

<h2>栄養計算（UI確認用）</h2>

<form method="post">

    <!-- hidden は form 冒頭にまとめる -->
    <input type="hidden" asp-for="Action" id="Action" />
    <input type="hidden" asp-for="HasUserSelectedPackage" />

    <!-- 以下、通常のUI -->
    
    <!-- ========================= -->
    <!-- 疾患選択 -->
    <!-- ========================= -->
    <div>
        <label>疾患</label><br />
        <select asp-for="SelectedDisease"
                asp-items="Html.GetEnumSelectList<DiseaseType>()"
                onchange="document.getElementById('Action').value='disease'; this.form.submit()" >
        </select>
    </div>

    <hr />

    <!-- ========================= -->
    <!-- カロリー算出方法 -->
    <!-- ========================= -->
    <div>
        <label>カロリー算出方法</label><br />
        <select asp-for="SelectedEnergyOrder"
                asp-items="Html.GetEnumSelectList<EnergyOrderType>()"
                onchange="document.getElementById('Action').value='order'; this.form.submit()">
        </select>
    </div>

    <!-- ========================= -->
    <!-- 投与カロリー -->
    <!-- ========================= -->
    <div>
        <label>投与カロリー</label><br />
        <input asp-for="EnergyOrderValue"
               onchange="document.getElementById('Action').value='energy'; this.form.submit()" /> kcal
    </div>

    <!-- 手入力モード -->
    @if (Model.SelectedEnergyOrder == EnergyOrderType.Manual)
    {
        <div>
            <label>手入力カロリー</label><br />
            <input asp-for="ManualEnergyValue" /> kcal
        </div>
    }

    <hr />

    <!-- ========================= -->
    <!-- 経腸栄養剤 -->
    <!-- ========================= -->
    <div>
        <label>経腸栄養剤</label><br />
        <select asp-for="SelectedEnteralFormula"
                asp-items="Html.GetEnumSelectList<EnteralFormulaType>()"
                onchange="document.getElementById('Action').value='formula'; this.form.submit()">
        </select>
    </div>

    <!-- ========================= -->
    <!-- 規格 -->
    <!-- ========================= -->
    <div>
        <label>規格（mL）</label><br />
        <select asp-for="SelectedPackageVolume"
                asp-items="Model.PackageVolumeOptions"
                onchange="document.getElementById('Action').value='package'; this.form.submit()">
        </select>
    </div>

    <hr />
     

    @if (Model.EnteralVolume.HasValue)
    {
        <h4>投与量</h4>
        <p>
            <strong>@Model.EnteralVolume.Value.ToString("F0")</strong> mL / day
        </p>

        @* ここを追加 *@
        @if (Model.EnteralPackagePlans != null && Model.EnteralPackagePlans.Any())
        {
            <h4>割付候補（規格×本数 + 端数）</h4>
            <ol>
                @foreach (var plan in Model.EnteralPackagePlans)
                {
                    <li>@IndexModel.FormatPlan(plan)</li>
                }
            </ol>
        }

        <h4>成分</h4>
        <ul>
            <li>蛋白質：@Model.EnteralProtein.Value.ToString("F1") g</li>
            <li>脂質：@Model.EnteralFat.Value.ToString("F1") g</li>
            <li>糖質：@Model.EnteralCarb.Value.ToString("F1") g</li>
            <li>食塩：@Model.EnteralSalt.Value.ToString("F2") g</li>
            <li>ビタミンK：@Model.EnteralVitaminK.Value.ToString("F1") µg</li>
            <li>水分量：@Model.EnteralWater.Value.ToString("F0") mL</li>
        </ul>
    }


    <!-- ========================= -->
    <!-- デバッグ表示 -->
    <!-- ========================= -->
    <h3>現在の Model 状態（確認用）</h3>
    <pre>
Disease               : @Model.SelectedDisease
EnergyOrderType       : @Model.SelectedEnergyOrder
EnergyOrderValue      : @Model.EnergyOrderValue
ManualEnergyValue     : @Model.ManualEnergyValue
Formula               : @Model.SelectedFormula
IsEnergyManualEdited  : @Model.IsEnergyManuallyEdited
EnteralEnergy         : @Model.EnteralEnergy
SelectedFormula       : @Model.SelectedEnteralFormula
HasUserSelectedPackage: @Model.HasUserSelectedPackage
Action                : @Model.Action
SelectedPackageVolume : @Model.SelectedPackageVolume
EnergyOrderValue(in)   : @Model.EnergyOrderValue
EnteralVolume          : @Model.EnteralVolume
Target Plans Count     : @(Model.EnteralPackagePlans?.Count ?? 0)
First Plan             : @(Model.EnteralPackagePlans?.FirstOrDefault())
</pre>

</form>
