@page
@model IndexModel
@using TNTCalculatorRazor.Domain.Enums

<div class="appbar">
    <div class="brand">
        <img src="~/img/TNTCalculatorSmall.png" class="brand-icon" alt="app icon" asp-append-version="true" />
        <span class="brand-meta-inline">TNTCalculator Ver. @(Model.AppVersion) by tyama</span>
        <a class="brand-link"
           href="/Help"
           onclick="openHelpWindow(event, this.href);">
            公式一覧
        </a>
        @if (Model.ShowInternalManualLink && !string.IsNullOrEmpty(Model.InternalManualUrl))
        {
            <a class="brand-link"
               href="@Model.InternalManualUrl"
               target="_blank"
               rel="noopener">
                院内マニュアル(EN-map)
            </a>
        }
    </div>
</div>


<form method="post">
    <input type="hidden" asp-for="Action" id="Action" />
    <input asp-for="IsProteinCorrectionUserEdited" type="hidden" />  
    <div class="layout">
 
        <!-- ========================= -->
        <!-- 左：入力 -->
        <!-- ========================= -->
        <div class="main">
            <!-- スマホ初回のみ：ホーム画面追加の案内 -->
            <div id="homehint" class="homehint homehint--dismissible" style="display:none;">
                <div class="homehint-text">
                    スマホは「ホーム画面に追加」するとすぐ開けます。Androidでは「インストール」と表示される場合がありますが、オフライン対応などのアプリ化はしていません。
                </div>
                <button type="button" class="homehint-close" aria-label="閉じる">×</button>
            </div>

            <div class="card">
                <div class="section-head">
                    <h3>基本入力</h3>
                    <div class="section-meta">
                        （栄養：年齢･身長･体重･性別）/（推定CCr：年齢･体重･Cr･性別）
                    </div>
                </div>

                @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                {
                    <div class="validation-summary text-danger" asp-validation-summary="ModelOnly"></div>
                }

                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">年齢</div>
                        <div class="control">
                            <input asp-for="Age" type="number" step="1" inputmode="numeric"
                                   onkeydown="submitOnEnter(event,'anthro')"
                                   onblur="tntSubmitOnBlurSmart(this.form);" />
                            <span class="unit">歳</span>
                            @if (ViewData.ModelState.TryGetValue("Age", out var entryAge) && entryAge.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Age"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">身長</div>
                        <div class="control">
                            <input asp-for="Height" type="number" step="0.1" inputmode="decimal"
                                   onkeydown="submitOnEnter(event,'anthro')"
                                   onblur="tntSubmitOnBlurSmart(this.form);" />
                            <span class="unit">cm</span>

                            @if (ViewData.ModelState.TryGetValue("Height", out var entryHeight) && entryHeight.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Height"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">体重</div>
                        <div class="control">
                            <input asp-for="Weight" type="number" step="0.1" inputmode="decimal"
                                   onkeydown="submitOnEnter(event,'anthro')"
                                   onblur="tntSubmitOnBlurSmart(this.form);" />
                            <span class="unit">kg</span>

                            @if (ViewData.ModelState.TryGetValue("Weight", out var entry) && entry.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Weight"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">Cr</div>
                        <div class="control">
                            <input asp-for="SerumCreatinine"
                                   type="number" step="0.01" inputmode="decimal"
                                   onchange="document.getElementById('Action').value='renal'; this.form.submit();"
                                   onblur="tntSubmitOnBlur(event,'renal')"
                                   onkeydown="submitOnEnter(event,'renal')" />

                            <span class="unit">mg/dL</span>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">性別</div>
                        <div class="control">
                            <div class="inline-controls">
                                <select asp-for="Gender"
                                        asp-items="Html.GetEnumSelectList<GenderType>()"
                                        onchange="document.getElementById('Action').value='anthro'; this.form.submit();">
                                </select>

                                @{
                                    bool showPregnant =
                                    Model.Gender == GenderType.Female
                                    && Model.Age.HasValue
                                    && Model.Age.Value >= 18
                                    && Model.Age.Value <= 55;
                                }

                                @if (showPregnant)
                                {
                                    <label class="inline-check"
                                           title="妊娠かつ肥満度120%以上では、水分計算に調整体重を使用します。">
                                        <input asp-for="IsPregnant"
                                               onchange="document.getElementById('Action').value='anthro'; this.form.submit();" />
                                        妊娠
                                    </label>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                @if (!(Model.Age.HasValue && Model.Age.Value < 18))
                {
                    <div class="field field-compact">
                        <div class="label">疾患</div>
                        <div class="control">
                            <select asp-for="SelectedDisease"
                                    asp-items="Html.GetEnumSelectList<DiseaseType>()"
                                    onchange="document.getElementById('Action').value='disease'; this.form.submit();">
                            </select>
                        </div>
                    </div>
                }
            </div>

            <div class="card">
                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">活動係数</div>
                        <div class="control">
                            <select asp-for="ActivityFactor"
                                    asp-items="Html.GetEnumSelectList<ActivityFactorType>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>
                    <div class="field field-compact">
                        <div class="label">ストレス係数</div>
                        <div class="control">
                            <select asp-for="StressFactor"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<StressFactorType>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">体温補正</div>
                        <div class="control">
                            <select asp-for="SelectedBodyTemperature"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<BodyTemperatureLevel>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">褥瘡</div>
                        <div class="control">
                            <select asp-for="SelectedPressureUlcer"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<PressureUlcerLevel>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    @if (Model.SelectedDisease == DiseaseType.LiverCirrhosis)
                    {
                        <div class="field sub">
                            <div class="label">肝性脳症</div>
                            <div class="control">
                                <label style="display:flex;gap:8px;align-items:center;">
                                    <input asp-for="IsHepaticEncephalopathy"
                                           type="checkbox"
                                           onchange="document.getElementById('Action').value='hepatic'; this.form.submit();" />
                                    あり（蛋白不耐）
                                </label>
                                <span class="muted small">※ ONで蛋白補正 0.5 + 肝不全用アミノ酸製剤を検討</span>
                            </div>
                        </div>
                    }

                    <div class="field field-compact">
                        <div class="label">蛋白補正</div>
                        <div class="control">
                            <select asp-for="SelectedProteinCorrection"
                                    asp-items="Html.GetEnumSelectList<ProteinCorrectionType>()"
                                    onchange="document.getElementById('Action').value='protein'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3>必要エネルギー</h3>

                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">算出方法</div>
                        <div class="control">
                            <select asp-for="SelectedEnergyOrder"
                                    asp-items="Html.GetEnumSelectList<EnergyOrderType>()"
                                    onchange="document.getElementById('Action').value='order'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">必要エネルギー</div>
                        <div class="control">
                            <input asp-for="EnergyOrderValue"
                                   type="number" step="1" inputmode="numeric"
                                   onchange="document.getElementById('Action').value='energy'; this.form.submit();"
                                   onkeydown="submitOnEnter(event,'energy')" />
                            <span class="unit">kcal/day</span>
                            @if (Model.IsEnergyUserEdited)
                            {
                                <span class="pill">手動編集</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="hr"></div>
            
                <details class="fold">
                    <summary>エネルギー候補（参考）</summary>
                    <div class="small" style="margin-top:10px;">
                        <dl class="kv kv-2col-energy">
                            <dt>基礎代謝量×係数</dt>
                            <dd>@(Model.EnergyByBmrKcal?.ToString() ?? "-") kcal</dd>
                            <dt>25kcal/標準体重</dt>
                            <dd>@(Model.Kcal25?.ToString() ?? "-") kcal</dd>
                            <dt>30kcal/標準体重</dt>
                            <dd>@(Model.Kcal30?.ToString() ?? "-") kcal</dd>
                            <dt>35kcal/標準体重</dt>
                            <dd>@(Model.Kcal35?.ToString() ?? "-") kcal</dd>
                        </dl>
                    </div>
                </details>
            </div>
        </div>
        
        <!-- ========================= -->
        <!-- 右：結果 + 経腸 -->
        <!-- ========================= -->
        <div class="summary">

            <!-- 追加：右カラム先頭（スマホで先に読む3点） -->
            <div class="card summary-hero">
                <h3>結果（要点）</h3>

                <div class="hero3">
                    <div class="hero3-item">
                        <div class="hero3-label">蛋白</div>
                        <div class="hero3-value">
                            @if (!string.IsNullOrEmpty(Model.ProteinDisplayText))
                            {
                                <strong>@Model.ProteinDisplayText</strong>
                                <span class="value-tail">
                                    <span class="unit">g</span>
                                    @if (Model.SelectedProteinCorrection != ProteinCorrectionType.None)
                                    {
                                        <span class="pill mini">補正</span>
                                    }
                                </span>
                            }
                            else
                            {
                                <span class="muted">-</span>
                                <span class="unit">g</span>
                            }
                            
                        </div>
                    </div>

                    <div class="hero3-item">
                        <div class="hero3-label">水分</div>
                        <div class="hero3-value">
                            @if (Model.WaterDisplay.HasValue)
                            {
                                <strong>@Model.WaterDisplay.Value</strong>
                                <span class="value-tail">
                                    <span class="unit">mL</span>
                                    @if (Model.WaterFeverCorrected)
                                    {
                                        <span class="pill mini">発熱</span>
                                    }
                                </span>
                            }
                            else
                            {
                                <span class="muted">-</span>
                                <span class="unit">mL</span>
                            }
                        </div>
                    </div>

                    <div class="hero3-item">
                        <div class="hero3-label">推定CCr</div>
                        <div class="hero3-value">
                            @if (Model.CcrCorrected.HasValue)
                            {
                                <strong>@Model.CcrCorrected.Value.ToString("F1")</strong>
                                <span class="value-tail">
                                    <span class="unit">mL/min</span>
                                    <span class="pill mini">補正</span>
                                </span>
                            }
                            else if (Model.CcrActual.HasValue)
                            {
                                <strong>@Model.CcrActual.Value.ToString("F1")</strong>
                                <span class="unit">mL/min</span>
                            }
                            else
                            {
                                <span class="muted">-</span>
                                <span class="unit">mL/min</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- 以下、既存の結果（詳細）カードや経腸栄養カードが続く -->
            <details class="fold result-details" open>
                <summary>結果（詳細）</summary>

            <div class="card result-card">
                <h3>結果</h3>

                <div class="two-col">
                    <div>
                        <!-- "kv kv-tight" 2行表示から"kv kv-need"1行表示に変更 -->
                        <dl class="kv kv-need">
                            <dt>基礎代謝量</dt>
                            <dd>
                            @if (Model.BmrKcal.HasValue)
                            {
                                <strong>@Model.BmrKcal.Value.ToString()</strong>
                                <span class="unit">kcal</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">kcal</span>
                                }
                                @* pill は dd 側へ移動（IE段ズレ対策、ストレス合計と同じ構造） *@
                                <div class="pills bmr-pills" style="margin-top:0px;">
                                    @* 算出法 pill：計算前も表示 *@
                                    <span class="pill mini trunc" title="@Model.BmrFormulaDisplayLong">
                                        @(!string.IsNullOrWhiteSpace(Model.BmrFormulaDisplay) ? Model.BmrFormulaDisplay : "算出法")
                                    </span>

                                    @* 体重 pill：計算前は「使用体重」、計算後は「実測50.0/標準50.0/調整50.0」 *@
                                    @if (Model.BmrWeightBasis.HasValue && Model.BmrWeightUsed.HasValue)
                                    {
                                        <span class="pill mini" title="@Model.BmrWeightBasis.Value.ToLongName()">
                                            @( $"{Model.BmrWeightBasis.Value.ToKindName()}{Model.BmrWeightUsed.Value:F1}kg" )
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="pill mini" title="BMR算出に使用する体重（計算後に 実測/標準/調整 が確定します）">
                                            使用体重
                                        </span>
                                    }
                                </div>
                            </dd>

                            <dt>BMI</dt>
                            <dd>
                                @if (Model.BodyIndex != null)
                                {
                                    <strong>@Model.BodyIndex.Bmi.ToString("F1")</strong>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                }
                            </dd>

                            <dt>標準体重</dt>
                            <dd>
                                @if (Model.BodyIndex != null)
                                {
                                    <strong>@Model.BodyIndex.StandardWeight.ToString("F1")</strong>
                                    <span class="unit">kg</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">kg</span>
                                }
                            </dd>

                            <dt>肥満度</dt>
                            <dd>
                                @if (Model.BodyIndex?.ObesityDegree != null)
                                {
                                    <strong>@Model.BodyIndex.ObesityDegree.Value.ToString("F0")</strong>
                                    <span class="unit">%</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">%</span>
                                }
                            </dd>

                            <dt>体表面積</dt>
                            <dd>
                                @if (Model.BodySurfaceArea.HasValue)
                                {
                                    <strong>@Model.BodySurfaceArea.Value.ToString("F3")</strong>
                                    <span class="unit">m²</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">m²</span>
                                }
                            </dd>

                            <dt>推定CCr</dt>
                            <dd>
                            @if (Model.CcrActual.HasValue)
                            {
                                @* 主役：補正後（あれば補正後、なければ補正前） *@
                                var ccrMain = Model.CcrCorrected ?? Model.CcrActual;

                                <strong>@ccrMain.Value.ToString("F1")</strong>
                                <span class="unit">mL/min</span>
                                        @* 参照：補正がある場合のみ、補正前を pill で表示 *@
                                        @if (Model.CcrCorrected.HasValue)
                                        {
                                            <span class="pill" style="margin-left:6px;">
                                                @($"補正前 {Model.CcrActual.Value.ToString("F1")}")
                                            </span>
                                        }

                                        @* 注記（補正条件など） *@
                                        @if (!string.IsNullOrWhiteSpace(Model.CcrNote))
                                        {
                                            <div class="muted small" style="margin-top:4px; line-height:1.2;">
                                                @Model.CcrNote
                                            </div>
                                        }
                            }
                            else
                            {
                                <span class="muted">-</span>
                                        <span class="unit">mL/min</span>
                            }
                            </dd>
                        </dl>
                    </div>

                    <div>
                        <h4>必要量</h4>
                        <dl class="kv kv-need">
                            @*
                            <dt>ストレス合計</dt>
                            <dd>
                                <div class="need-line">
                                    @Model.StressTotal.ToString("F1")
                                    <span class="pill mini">基礎 @Model.StressBase.ToString("F2")</span>
                                </div>

                                <div class="need-line">
                                    <span class="pill mini">熱 @Model.StressTemperature.ToString("F1")</span>
                                    <span class="pill mini">褥 @Model.StressPressureUlcer.ToString("F1")</span>
                                </div>
                            </dd>
                            *@

                            <dt>必要エネルギー</dt>
                            <dd>
                                @if (Model.EnergyFinal.HasValue)
                                {
                                    <strong>@Model.EnergyFinal.Value.ToString()</strong>
                                    <span class="unit">kcal</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">kcal</span>
                                }
                            </dd>

                            <dt>蛋白</dt>
                            <dd>
                                @if (!string.IsNullOrEmpty(Model.ProteinDisplayText))
                                {
                                    <strong>@Model.ProteinDisplayText</strong>
                                    <span class="unit">g</span>
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                    <span class="unit">g</span>
                                }
                            
                                @if (Model.SelectedProteinCorrection != ProteinCorrectionType.None)
                                {
                                    <span class="pill mini" style="margin-left:6px;">
                                        @(
                                          Model.SelectedProteinCorrection switch
                                          {
                                              ProteinCorrectionType.CKD3bTo5 => "補正0.7",
                                              ProteinCorrectionType.LiverCirrhosisPoor => "補正0.5",
                                              _ => "補正"
                                          }
                                         )
                                    </span>
                                }
                            </dd>

                            <dt>水分</dt>
                            <dd>
                            @if (Model.WaterDisplay.HasValue)
                            {
                                <strong>@Model.WaterDisplay.Value.ToString()</strong>
                                <span class="unit">mL</span>
                            }
                            else
                            {
                                <span class="muted">-</span>
                                <span class="unit">mL</span>
                            }
                            @if (Model.WaterFeverCorrected)
                            {
                                <span class="pill mini" style="margin-left:6px;">発熱</span>
                            }
                            </dd>
                        </dl>
                        @if (Model.IsHemodialysis)
                        {
                            <div class="muted small">※水分は目安（DW・体重推移で判断）</div>
                        }
                        @if (Model.SelectedDisease == DiseaseType.LiverCirrhosis && Model.IsHepaticEncephalopathy)
                        {
                            <div class="muted small">※肝不全用アミノ酸製剤の併用を検討</div>
                        }
                    </div>
                </div>

                <div class="hr"></div>
                
                <details class="fold">
                    <summary>補足（考え方・注意点）</summary>
                    <div class="small" style="margin-top:10px;">
                        <ul style="margin:0; padding-left:18px;">
                            <li><b>BMR式</b>：乳児 KPUM7／小児 DRI2010／成人は条件で HB または G07。</li>
                            <li><b>体重</b>：乳児は実測。その他は肥満度≤80%標準、80–120%実測、≥120%調整。</li>
                            <li><b>水分（発熱）</b>：透析以外は加算、血液透析は一律加算なし。</li>
                        </ul>
                        @* 疾患別の目安：選択した疾患のときだけ *@
                        @if (Model.SelectedDisease != DiseaseType.None)
                        {
                            <div style="margin-top:10px;">
                                <div class="muted" style="margin-bottom:6px;">疾患別の目安（参考）</div>

                                @switch (Model.SelectedDisease)
                                {
                                    case DiseaseType.Diabetes:
                                        <ul style="margin:0; padding-left:18px;">
                                            <li>軽い労作：25kcal/標準体重</li>
                                            <li>普通労作：30kcal/標準体重</li>
                                            <li>重い労作：35kcal/標準体重</li>
                                        </ul>
                                        break;

                                    case DiseaseType.RenalFailure:
                                        <ul style="margin:0; padding-left:18px;">
                                            <li>エネルギー：25～35kcal/標準体重</li>
                                            <li><b>蛋白（目安）</b>：CKD1-2 過剰摂取を避ける／CKD3a 0.8～1.0 g/標準体重</li>
                                            <li>CKD3b-5：0.6～0.8 g/標準体重</li>
                                        </ul>
                                        break;

                                    case DiseaseType.Hemodialysis:
                                        <ul style="margin:0; padding-left:18px;">
                                            <li>エネルギー：30～35kcal/標準体重</li>
                                            <li>水分：15mL/kg は目安（ドライウェイト・体重推移で判断）</li>
                                            <li><b>蛋白（目安）</b>：0.9～1.2 g/標準体重</li>
                                        </ul>
                                        break;

                                    case DiseaseType.LiverCirrhosis:
                                        <ul style="margin:0; padding-left:18px;">
                                            <li>耐糖能異常なし：30～40kcal/標準体重</li>
                                            <li>耐糖能異常あり：25～30kcal/標準体重</li>
                                            <li><b>蛋白（目安）</b>：不耐なし 1.0～1.5 g/標準体重</li>
                                            <li>不耐あり 0.5～0.7 g/標準体重＋肝不全用栄養</li>
                                        </ul>
                                        break;
                                }
                            </div>
                        }
                        @* 小児（動的に注意） *@
                        @if (Model.Age.HasValue && Model.Age.Value < 18)
                        {
                            <div class="muted" style="margin-top:8px;">
                                小児：疾患選択なし。蛋白補正は必要に応じて手動調整。
                            </div>
                        }

                    </div>
                </details>
            </div>
            </details>

            <div class="card enteral-card">
                <h3>経腸栄養</h3>
                                
                <div class="fields">

                    <div class="field">
                        <div class="label">経腸栄養剤</div>
                        <div class="control">
                            <select asp-for="SelectedEnteralFormula"
                                    asp-items="Html.GetEnumSelectList<EnteralFormulaType>()"
                                    onchange="document.getElementById('Action').value='formula'; this.form.submit();">
                                <option value="">-- 選択してください -- [ mL/袋 (kcal/袋) ] </option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">投与量</div>
                        <div class="control">
                            <input asp-for="EnteralVolumeInput"
                                   type="number" step="1" inputmode="numeric"
                                   onchange="document.getElementById('Action').value='volume'; this.form.submit();"
                                   onkeydown="submitOnEnter(event,'volume')" />
                            <span class="unit">mL</span>
                            <span class="muted small">※手入力可(kcal同期)</span>
                        </div>
                    </div>

                </div>
                
                @if (Model.EnteralVolume.HasValue)
                {
                    <!-- 追加：スマホで折りたたむ領域 -->
                    <details class="fold enteral-details" open>
                        <summary>成分・割付候補</summary>

                    <div class="enteral-top">
                        <div class="enteral-box">
                            <h4>計算結果</h4>
                            <p>
                                投与量：<strong>@Model.EnteralVolume.Value.ToString("F0")</strong> mL<br />
                                投与カロリー：<strong>@(Model.EnteralEnergy?.ToString("F0") ?? "-")</strong> kcal
                            </p>
                        </div>
                        <div class="enteral-box">
                            <h4>割付候補</h4>
                            <ul class="compact-list">
                                @foreach (var plan in Model.EnteralPackagePlans)
                                {
                                    <li>@IndexModel.FormatPlan(plan)</li>
                                }
                            </ul>
                        </div>
                    </div>

                    <div class="enteral-bottom">
                        <h4>成分（投与量ベース）</h4>
                       <dl class="kv kv-2col">
                            <dt>蛋白質</dt>
                            <dd>@(Model.EnteralProtein?.ToString("F1") ?? "-") g</dd>
                            <dt>脂質</dt>
                            <dd>@(Model.EnteralFat?.ToString("F1") ?? "-") g</dd>
                            <dt>糖質</dt>
                            <dd>@(Model.EnteralCarb?.ToString("F1") ?? "-") g</dd>
                            <dt>食塩</dt>
                            <dd>@(Model.EnteralSalt?.ToString("F2") ?? "-") g</dd>
                            <dt>ビタミンK</dt>
                            <dd>@(Model.EnteralVitaminK?.ToString("F1") ?? "-") µg</dd>
                            <dt>水分量</dt>
                            <dd>@(Model.EnteralWater?.ToString("F0") ?? "-") mL</dd>
                        </dl>
                    </div>

                    </details>
                }
            </div>
            @*
            <div class="card">
                <details class="fold">
                    <summary>デバッグ（開発中）</summary>
                    <pre class="small" style="white-space:pre-wrap;margin-top:10px;">
                    Action                : @Model.Action
                    Age/Height/Weight     : @Model.Age / @Model.Height / @Model.Weight
                    Gender                : @Model.Gender
                    Disease               : @Model.SelectedDisease
                    EnergyOrderType       : @Model.SelectedEnergyOrder
                    EnergyOrderValue      : @Model.EnergyOrderValue
                    IsEnergyUserEdited    : @Model.IsEnergyUserEdited
                    Formula               : @Model.SelectedEnteralFormula
                    EnteralVolumeInput    : @Model.EnteralVolumeInput
                    EnteralVolume         : @Model.EnteralVolume
                    EnteralEnergy         : @Model.EnteralEnergy
                    StressTotal           : @Model.StressTotal
                    PressureUlcer         : @Model.SelectedPressureUlcer
                    StressPressureUlcer   : @Model.StressPressureUlcer
                    CorrectedWeight(debug): @Model.DebugWeightLine
                    </pre>
                </details>
            </div>
            *@
        </div>
    </div>
</form>

<!-- EnterでSubmit -->
<script>
    // Enterで送信した直後のblurによる二重送信を防ぐフラグ
    var tntSkipNextBlurSubmit = false;

    function tntSubmitOnBlur(e, action) {
        if (tntSkipNextBlurSubmit) {
            tntSkipNextBlurSubmit = false;
                return false;
        }

        var actionEl = document.getElementById("Action");
        if (actionEl) actionEl.value = action;

        var target = (e && (e.target || e.srcElement)) || null;
        var form = target && target.form ? target.form : document.querySelector("form");
        if (form) form.submit();
        return false;
    }

    function submitOnEnter(e, action) {
        e = e || window.event;
        var code = e.keyCode || e.which;

        if (code === 13) {
            if (e.preventDefault) e.preventDefault();
            e.returnValue = false;

            tntSkipNextBlurSubmit = true; // ←これが肝

            var actionEl = document.getElementById("Action");
            if (actionEl) actionEl.value = action;

            var target = e.target || e.srcElement;
            var form = target && target.form ? target.form : document.querySelector("form");
            if (form) form.submit();

            return false;
        }
    }
</script>
       
<script>
    // スマートblur submit(onblur制御）
    function _trim(v) {
        return v ? v.replace(/^\s+|\s+$/g, '') : '';
    }

    function tntSubmitOnBlurSmart(form) {
        var age = document.getElementById('Age');
        var h   = document.getElementById('Height');
        var w   = document.getElementById('Weight');
        var cr  = document.getElementById('SerumCreatinine');
        var act = document.getElementById('Action');

        var heightStr = _trim(h && h.value);
        var weightStr = _trim(w && w.value);
        var crStr     = _trim(cr && cr.value);

        // どちらの計算を走らせるべきか決める（renal優先）
        var doRenal  = (weightStr !== '' && crStr !== '');
        var doAnthro = (weightStr !== '' && heightStr !== '');

        if (!doRenal && !doAnthro) return;

        // blur直後に別inputへ移動中だと submit がキーボードを閉じるので、
        // いったん次のfocusを待って、入力継続中なら submit しない（後続の入力欄側に任せる）
        setTimeout(function () {
            var ae = document.activeElement;
            var id = ae && ae.id ? ae.id : '';

            // 入力を続けている（別フィールドを触った）なら送信しない
            if (id === 'Age' || id === 'Height' || id === 'Weight' || id === 'SerumCreatinine') {
                return;
            }

            if (act) act.value = doRenal ? 'renal' : 'anthro';
            form.submit();
        }, 0);
    }
</script>

<script>
    // ヘルプウィンドウを開く
    function openHelpWindow(e, url) {
        e.preventDefault(); // 既定遷移（=二重オープン）を止める

        var name = "TNT_Help";
        var features = "width=900,height=800,resizable=yes,scrollbars=yes";

        var w = window.open(url, name, features);

        // ポップアップがブロックされたら、新しいタブで開く（フォールバック）
        if (!w) {
            window.open(url, "_blank", "noopener");
            return;
        }

        try { w.focus(); } catch (e) {}
    }
</script>

<!-- スマホ時：初期表示調整（details折りたたみ + 初回案内） -->
<script>
    (function () {
        var isMobile = false;

        if (window.matchMedia) {
            isMobile = window.matchMedia("(max-width: 980px)").matches;
        } else {
            var w = document.documentElement.clientWidth || document.body.clientWidth;
            isMobile = (w <= 980);
        }

        if (!isMobile) return;

        // detailsのopenを外す(初期で折りたたむ)
        var list = document.querySelectorAll(".enteral-details, .result-details");
        for (var i = 0; i < list.length; i++) {
            list[i].removeAttribute("open");
        }

        // 初回だけホーム画面追加の案内を表示（×で閉じたら二度と出さない）
        var key = "tnt_homehint_dismissed_v1";
        try {
            if (window.localStorage && localStorage.getItem(key) === "1") return;
        } catch (e) {}

        var el = document.getElementById("homehint");
        if (!el) return;

        el.style.display = "flex";

        var btn = el.querySelector(".homehint-close");
        if (btn) {
            btn.onclick = function () {
                try {
                    if (window.localStorage) localStorage.setItem(key, "1");
                } catch (e) {}

                if (el && el.parentNode) el.parentNode.removeChild(el);
                return false;
            };
        }
    })();
</script>

<!-- IEで<details>全開を止める：summaryクリックを自前で入れる -->
<script>
    (function () {
        var test = document.createElement("details");
        if ("open" in test) return; // 対応ブラウザは何もしない

        var details = document.getElementsByTagName("details");

        for (var i = 0; i < details.length; i++) {
            (function (d) {
                var summary = d.getElementsByTagName("summary")[0];
                if (!summary) return;

                function apply(open) {
                    if (open) d.setAttribute("open", "open");
                    else d.removeAttribute("open");

                    for (var j = 0; j < d.children.length; j++) {
                        var child = d.children[j];
                        if (child.tagName && child.tagName.toLowerCase() === "summary") continue;
                        child.style.display = open ? "" : "none";
                    }
                }

                var isOpen = d.getAttribute("open") !== null;
                apply(isOpen);

                summary.onclick = function (e) {
                    if (e && e.preventDefault) e.preventDefault();
                    isOpen = !isOpen;
                    apply(isOpen);
                    return false;
                };
            })(details[i]);
        }
    })();
</script>

<!-- 入力欄のblurでActionセット -->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        var form = document.querySelector("form");
        if (!form) return;

        var nodes = form.querySelectorAll("input[type='number'], input[type='text'], select");
        for (var i = 0; i < nodes.length; i++) {
            nodes[i].addEventListener("blur", function () {
                var action = document.getElementById("Action");
                if (action && !action.value) action.value = "calc";
            });
        }
    });
</script>
