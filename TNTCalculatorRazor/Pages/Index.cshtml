@page
@model IndexModel
@using TNTCalculatorRazor.Domain.Enums

    <div class="appbar">
        <div class="brand">
            <img src="~/img/TNTCalculatorSmall.png" class="brand-icon" alt="app icon" asp-append-version="true" />
            <span class="brand-meta-inline">TNTCalculator Ver. @(Model.AppVersion) by tyama</span>
        <a class="brand-link"
           href="/Help"
           onclick="openHelpWindow(event, this.href);">
            公式一覧
        </a>
        </div>
    </div>


<form method="post">
    <input type="hidden" id="Action" name="Action" value="" />
    <input asp-for="IsProteinCorrectionUserEdited" type="hidden" />
   
    <div class="layout">

        <!-- ========================= -->
        <!-- 左：入力 -->
        <!-- ========================= -->
        <div class="main">

            <div class="card">
                <div class="section-head">
                    <h3>基本入力</h3>
                    <div class="section-meta">
                        （栄養：年齢・身長・体重・性別）/（推定CCr：年齢・体重・Cr・性別）
                    </div>
                </div>

                @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                {
                    <div class="validation-summary text-danger" asp-validation-summary="ModelOnly"></div>
                }

                <div class="fields">

                    <div class="field">
                        <div class="label">年齢</div>
                        <div class="control">
                            <input asp-for="Age" type="number" step="1" inputmode="numeric"
                                   onkeydown="submitOnEnter(event,'anthro')" />
                            <span class="unit">歳</span>
                            @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                            {
                                <div class="field-error text-danger"><span asp-validation-for="Age"></span></div>                
                            }
                            </div>
                    </div>

                    <div class="field">
                        <div class="label">身長</div>
                        <div class="control">
                            <input asp-for="Height" type="number" step="0.1" inputmode="decimal"
                                   onkeydown="submitOnEnter(event,'anthro')" />
                            <span class="unit">cm</span>
                            @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                            {
                                <div class="field-error text-danger"><span asp-validation-for="Height"></span></div>
                            }
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">体重</div>
                        <div class="control">
                            <input asp-for="Weight" type="number" step="0.1" inputmode="decimal"
                                   onkeydown="submitOnEnter(event,'anthro')" />
                            <span class="unit">kg</span>
                            @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                            {
                                <div class="field-error text-danger"><span asp-validation-for="Weight"></span></div>
                            }
                        </div>
                    </div>


                    <div class="field">
                        <div class="label">Cr</div>
                        <div class="control">
                            <input asp-for="SerumCreatinine"
                                   type="number" step="0.01" inputmode="decimal"
                                   onchange="document.getElementById('Action').value='renal'; this.form.submit();" />
                            <span class="unit">mg/dL</span>
                        </div>
                    </div>



                    <div class="field">
                        <div class="label">性別</div>
                        <div class="control">
                            <select asp-for="Gender"
                                    asp-items="Html.GetEnumSelectList<GenderType>()"
                                    onchange="document.getElementById('Action').value='anthro'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card">
                @if (!(Model.Age.HasValue && Model.Age.Value < 18))
                {
                    <div class="field">
                        <div class="label">疾患</div>
                        <div class="control">
                            <select asp-for="SelectedDisease"
                                    asp-items="Html.GetEnumSelectList<DiseaseType>()"
                                    onchange="document.getElementById('Action').value='disease'; this.form.submit();">
                            </select>
                        </div>
                    </div>
                }
            </div>

            <div class="card">
                
                <div class="fields">

                    <div class="field">
                        <div class="label">活動係数</div>
                        <div class="control">
                            <select asp-for="ActivityFactor"
                                    asp-items="Html.GetEnumSelectList<ActivityFactorType>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">ストレス係数</div>
                        <div class="control">
                            <select asp-for="StressFactor"
                                    asp-items="Html.GetEnumSelectList<StressFactorType>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">体温補正</div>
                        <div class="control">
                            <select asp-for="SelectedBodyTemperature"
                                    asp-items="Html.GetEnumSelectList<BodyTemperatureLevel>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">褥瘡</div>
                        <div class="control">
                            <select asp-for="SelectedPressureUlcer"
                                    asp-items="Html.GetEnumSelectList<PressureUlcerLevel>()"
                                    onchange="document.getElementById('Action').value='factors'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    @if (Model.SelectedDisease == DiseaseType.LiverCirrhosis)
                    {
                        <div class="field sub">
                            <div class="label">肝性脳症</div>
                            <div class="control">
                                <label style="display:flex;gap:8px;align-items:center;">
                                    <input asp-for="IsHepaticEncephalopathy"
                                           type="checkbox"
                                           onchange="document.getElementById('Action').value='hepatic'; this.form.submit();" />
                                    あり（蛋白不耐）
                                </label>
                                <span class="muted small">※ ONで蛋白補正 0.5 + 肝不全用アミノ酸製剤を検討</span>
                            </div>
                        </div>
                    }

                    <div class="field">
                        <div class="label">蛋白補正</div>
                        <div class="control">
                            <select asp-for="SelectedProteinCorrection"
                                    asp-items="Html.GetEnumSelectList<ProteinCorrectionType>()"
                                    onchange="document.getElementById('Action').value='protein'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card">
                <h3>必要エネルギー</h3>

                <div class="fields">
                    <div class="field">
                        <div class="label">算出方法</div>
                        <div class="control">
                            <select asp-for="SelectedEnergyOrder"
                                    asp-items="Html.GetEnumSelectList<EnergyOrderType>()"
                                    onchange="document.getElementById('Action').value='order'; this.form.submit();">
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">必要エネルギー</div>
                        <div class="control">
                            <input asp-for="EnergyOrderValue"
                                   type="number" step="1" inputmode="numeric"
                                   onchange="document.getElementById('Action').value='energy'; this.form.submit();" />
                            <span class="unit">kcal/day</span>
                            @if (Model.IsEnergyUserEdited)
                            {
                                <span class="pill">手動編集</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="hr"></div>

                <details>
                    <summary>エネルギー候補（参考）</summary>
                    <div class="small" style="margin-top:10px;">
                        <dl class="kv kv-2col-energy">
                            <dt>基礎エネルギー×係数</dt>
                            <dd>@(Model.EnergyByBmrKcal?.ToString() ?? "-") kcal</dd>
                            <dt>25kcal/標準体重</dt>
                            <dd>@(Model.Kcal25?.ToString() ?? "-") kcal</dd>
                            <dt>30kcal/標準体重</dt>
                            <dd>@(Model.Kcal30?.ToString() ?? "-") kcal</dd>
                            <dt>35kcal/標準体重</dt>
                            <dd>@(Model.Kcal35?.ToString() ?? "-") kcal</dd>
                        </dl>
                    </div>
                </details>
            </div>

        </div>
        
        <!-- ========================= -->
        <!-- 右：結果 + 経腸 -->
        <!-- ========================= -->
        <div class="summary">

            <!-- 追加：右カラム先頭（スマホで先に読む3点） -->
            <div class="card summary-hero">
                <h3>要点</h3>

                <div class="hero3">
                    <div class="hero3-item">
                        <div class="hero3-label">蛋白</div>
                        <div class="hero3-value">
                            <strong>@(Model.ProteinDisplayText ?? "-")</strong>
                            <span class="unit">g</span>
                        </div>
                    </div>

                    <div class="hero3-item">
                        <div class="hero3-label">水分</div>
                        <div class="hero3-value">
                            <strong>@(Model.WaterDisplay?.ToString() ?? "-")</strong>
                            <span class="unit">mL</span>
                            @if (Model.WaterFeverCorrected)
                            {
                                <span class="pill mini" style="margin-left:6px;">発熱</span>
                            }
                        </div>
                    </div>

                    <div class="hero3-item">
                        <div class="hero3-label">推定CCr</div>
                        <div class="hero3-value">
                            @if (Model.CcrCorrected.HasValue)
                            {
                                <strong>@Model.CcrCorrected.Value.ToString("F1")</strong>
                                <span class="unit">mL/min</span>
                            }
                            else if (Model.CcrActual.HasValue)
                            {
                                <strong>@Model.CcrActual.Value.ToString("F1")</strong>
                                <span class="unit">mL/min</span>
                            }
                            else
                            {
                                <span class="muted">-</span>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- 以下、既存の結果（参照）カードや経腸栄養カードが続く -->
            <details class="result-details" open>
                <summary>結果（参照）</summary>

            <div class="card result-card">
                <h3>結果（参考）</h3>

                <div class="two-col">
                    <div>
                        
                        <dl class="kv kv-tight">
                            <dt>
                                BMR(基礎エネルギー)
                                @if (!string.IsNullOrWhiteSpace(Model.BmrFormulaDisplay)
                                                                && Model.BmrWeightBasis.HasValue
                                                                && Model.BmrWeightUsed.HasValue)
                                {
                                    <div class="pills" style="margin-top:0px;">
                                        <span class="pill mini trunc" title="@Model.BmrFormulaDisplayLong">
                                            @Model.BmrFormulaDisplay
                                        </span>

                                        <span class="pill mini">
                                            @( $"W{Model.BmrWeightBasis.Value.ToDisplayName()}{Model.BmrWeightUsed.Value.ToString("F1")}" )
                                        </span>
                                    </div>
                                }
                            </dt>
                            <dd>
                                @(Model.BmrKcal?.ToString() ?? "-") kcal
                            </dd>
                            
                            <dt>BMI</dt>
                            <dd>@(Model.BodyIndex != null ? Model.BodyIndex.Bmi.ToString("F1") : "-")</dd>

                            <dt>標準体重</dt>
                            <dd>@(Model.BodyIndex?.StandardWeight.ToString("F1") ?? "-") kg</dd>

                            <dt>肥満度</dt>
                            <dd>@(Model.BodyIndex?.ObesityDegree?.ToString("F0") ?? "-") %</dd>

                            <dt>体表面積</dt>
                            <dd>@(Model.BodySurfaceArea?.ToString("F3") ?? "-") m²</dd>

                            <dt>推定CCr</dt>
                            <dd>
                                @if (Model.CcrActual.HasValue)
                                {
                                    <strong>@Model.CcrActual.Value.ToString("F1")</strong>
                                    <span class="unit">mL/min</span>

                                    @if (Model.CcrCorrected.HasValue)
                                    {
                                        <span class="pill mini" style="margin-left:6px;">
                                            @($"補正{Model.CcrCorrected.Value.ToString("F1")}")
                                        </span>
                                    }

                                    @if (!string.IsNullOrWhiteSpace(Model.CcrNote))
                                    {
                                        <div class="muted small" style="margin-top:4px; line-height:1.2;">
                                            @Model.CcrNote
                                        </div>
                                    }
                                }
                                else
                                {
                                    <span class="muted">-</span>
                                }
                            </dd>


                        </dl>
                    </div>

                    <div>
                        <h4>必要量</h4>
                        <dl class="kv kv-need">
                            <dt>ストレス合計</dt>
                            <dd>
                                <div class="need-line">
                                    @Model.StressTotal.ToString("F1")
                                    <span class="pill mini">基礎 @Model.StressBase.ToString("F2")</span>
                                </div>

                                <div class="need-line">
                                    <span class="pill mini">熱 @Model.StressTemperature.ToString("F1")</span>
                                    <span class="pill mini">褥 @Model.StressPressureUlcer.ToString("F1")</span>
                                </div>
                            </dd>

                            <dt>必要エネルギー</dt>
                            <dd><strong>@(Model.EnergyFinal?.ToString() ?? "-")</strong> kcal</dd>

                            <dt>蛋白</dt>
                            <dd>
                                <strong>@(Model.ProteinDisplayText ?? "-")</strong> g
                                @if (Model.SelectedProteinCorrection != ProteinCorrectionType.None)
                                {
                                    <span class="pill mini" style="margin-left:6px;">
                                        @(
                                          Model.SelectedProteinCorrection switch
                                          {
                                              ProteinCorrectionType.CKD3bTo5 => "補正0.7",
                                              ProteinCorrectionType.LiverCirrhosisPoor => "補正0.5",
                                              _ => "補正"
                                          }
                                         )
                                    </span>
                                }
                            </dd>

                            <dt>水分</dt>
                            <dd>
                                <strong>@(Model.WaterDisplay?.ToString() ?? "-")</strong> mL
                                @if (Model.WaterFeverCorrected)
                                {
                                    <span class="pill mini" style="margin-left:6px;">発熱</span>
                                }
                            </dd>

                            

                        </dl>
                        @if (Model.IsHemodialysis)
                        {
                            <div class="muted small">※水分は目安（DW・体重推移で判断）</div>
                        }
                        @if (Model.SelectedDisease == DiseaseType.LiverCirrhosis && Model.IsHepaticEncephalopathy)
                        {
                            <div class="muted small">※肝不全用アミノ酸製剤の併用を検討</div>
                        }

                    </div>
                </div>

                <div class="hr"></div>
                
                <details>
                    <summary>補足（考え方・注意点）</summary>
                    <div class="small" style="margin-top:10px;">
                        <ul style="margin:0; padding-left:18px;">
                            <li><b>BMR式</b>：乳児 KPUM7／小児 DRI2010／成人は条件で HB または G07。</li>
                            <li><b>体重</b>：乳児は実測。その他は肥満度≤80%標準、80–120%実測、≥120%調整。</li>
                            <li><b>水分（発熱）</b>：透析以外は加算、血液透析は一律加算なし。</li>
                        </ul>
                        @* 疾患別の目安：選択した疾患のときだけ *@
                        @if (Model.SelectedDisease != DiseaseType.None)
                            {
                                <div style="margin-top:10px;">
                                    <div class="muted" style="margin-bottom:6px;">疾患別の目安（参考）</div>

                                    @switch (Model.SelectedDisease)
                                    {
                                        case DiseaseType.Diabetes:
                                            <ul style="margin:0; padding-left:18px;">
                                                <li>軽い労作：25kcal/標準体重</li>
                                                <li>普通労作：30kcal/標準体重</li>
                                                <li>重い労作：35kcal/標準体重</li>
                                            </ul>
                                            break;

                                        case DiseaseType.RenalFailure:
                                            <ul style="margin:0; padding-left:18px;">
                                                <li>エネルギー：25～35kcal/標準体重</li>
                                                <li><b>蛋白（目安）</b>：CKD1-2 過剰摂取を避ける／CKD3a 0.8～1.0 g/標準体重</li>
                                                <li>CKD3b-5：0.6～0.8 g/標準体重</li>
                                            </ul>
                                            break;

                                        case DiseaseType.Hemodialysis:
                                            <ul style="margin:0; padding-left:18px;">
                                                <li>エネルギー：30～35kcal/標準体重</li>
                                                <li>水分：15mL/kg は目安（ドライウェイト・体重推移で判断）</li>
                                                <li><b>蛋白（目安）</b>：0.9～1.2 g/標準体重</li>
                                            </ul>
                                            break;

                                        case DiseaseType.LiverCirrhosis:
                                            <ul style="margin:0; padding-left:18px;">
                                                <li>耐糖能異常なし：30～40kcal/標準体重</li>
                                                <li>耐糖能異常あり：25～30kcal/標準体重</li>
                                                <li><b>蛋白（目安）</b>：不耐なし 1.0～1.5 g/標準体重</li>
                                                <li>不耐あり 0.5～0.7 g/標準体重＋肝不全用栄養</li>
                                            </ul>
                                            break;
                                    }
                                </div>
                            }
                        @* 小児（動的に注意） *@
                        @if (Model.Age.HasValue && Model.Age.Value < 18)
                        {
                            <div class="muted" style="margin-top:8px;">
                                小児：疾患選択なし。蛋白補正は必要に応じて手動調整。
                            </div>
                        }

                    </div>
                 </details>
            </div>
            </details>

            <div class="card enteral-card">
                <h3>経腸栄養</h3>
                                
                <div class="fields">

                    <div class="field">
                        <div class="label">経腸栄養剤</div>
                        <div class="control">
                            <select asp-for="SelectedEnteralFormula"
                                    asp-items="Html.GetEnumSelectList<EnteralFormulaType>()"
                                    onchange="document.getElementById('Action').value='formula'; this.form.submit();">
                                <option value="">-- 選択してください -- [ mL/袋 (kcal/袋) ] </option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <div class="label">投与量</div>
                        <div class="control">
                            <input asp-for="EnteralVolumeInput"
                                   type="number" step="1" inputmode="numeric"
                                   onchange="document.getElementById('Action').value='volume'; this.form.submit();" />
                            <span class="unit">mL</span>
                            <span class="muted small">※手入力可(kcal同期)</span>
                        </div>
                    </div>

                </div>

                @if (Model.EnteralVolume.HasValue)
                {
                    <div class="enteral-top">
                        <div class="enteral-box">
                            <h4>計算結果</h4>
                            <p>
                                投与量：<strong>@Model.EnteralVolume.Value.ToString("F0")</strong> mL<br />
                                投与カロリー：<strong>@(Model.EnteralEnergy?.ToString("F0") ?? "-")</strong> kcal
                            </p>
                        </div>
                    </div>

                    <!-- 追加：スマホで折りたたむ領域 -->
                    <details class="enteral-details" open>
                        <summary>成分・割付候補</summary>

                        <div class="enteral-top">
                            <div class="enteral-box">
                                <h4>割付候補</h4>
                                <ul class="compact-list">
                                    @foreach (var plan in Model.EnteralPackagePlans)
                                    {
                                        <li>@IndexModel.FormatPlan(plan)</li>
                                    }
                                </ul>
                            </div>
                        </div>

                        <div class="enteral-bottom">
                            <h4>成分（投与量ベース）</h4>
                            <dl class="kv kv-2col">
                                <dt>蛋白質</dt>
                                <dd>@(Model.EnteralProtein?.ToString("F1") ?? "-") g</dd>
                                <dt>脂質</dt>
                                <dd>@(Model.EnteralFat?.ToString("F1") ?? "-") g</dd>
                                <dt>糖質</dt>
                                <dd>@(Model.EnteralCarb?.ToString("F1") ?? "-") g</dd>
                                <dt>食塩</dt>
                                <dd>@(Model.EnteralSalt?.ToString("F2") ?? "-") g</dd>
                                <dt>ビタミンK</dt>
                                <dd>@(Model.EnteralVitaminK?.ToString("F1") ?? "-") µg</dd>
                                <dt>水分量</dt>
                                <dd>@(Model.EnteralWater?.ToString("F0") ?? "-") mL</dd>
                            </dl>
                        </div>
                    </details>
                }

            <div class="card">
                <details>
                    <summary>デバッグ（開発中）</summary>
                    <pre class="small" style="white-space:pre-wrap;margin-top:10px;">
                    Action                : @Model.Action
                    Age/Height/Weight     : @Model.Age / @Model.Height / @Model.Weight
                    Gender                : @Model.Gender
                    Disease               : @Model.SelectedDisease
                    EnergyOrderType       : @Model.SelectedEnergyOrder
                    EnergyOrderValue      : @Model.EnergyOrderValue
                    IsEnergyUserEdited    : @Model.IsEnergyUserEdited
                    Formula               : @Model.SelectedEnteralFormula
                    EnteralVolumeInput    : @Model.EnteralVolumeInput
                    EnteralVolume         : @Model.EnteralVolume
                    EnteralEnergy         : @Model.EnteralEnergy
                    StressTotal           : @Model.StressTotal
                    PressureUlcer         : @Model.SelectedPressureUlcer
                    StressPressureUlcer   : @Model.StressPressureUlcer
          </pre>
                </details>
            </div>

        </div>
    </div>

    <!-- EnterでSubmit -->
    <script>
        function submitOnEnter(e, action) {
          if (e.key === "Enter") {
            e.preventDefault();
            document.getElementById("Action").value = action;
            e.target.form.submit();
          }
        }
    </script>
    <script>
        function openHelpWindow(e, url) {
          e.preventDefault(); // 既定遷移（=二重オープン）を止める

          var name = "TNT_Help";
          var features = "width=900,height=800,resizable=yes,scrollbars=yes";

          var w = window.open(url, name, features);

          // ポップアップがブロックされたら、新しいタブで開く（フォールバック）
          if (!w) {
            window.open(url, "_blank", "noopener");
            return;
          }

          try { w.focus(); } catch (e) {}
        }
    </script>

        <!-- スマホの初期で経腸栄養詳細を折りたたむ -->
        <script>
            if (window.matchMedia("(max-width: 980px)").matches) {
                document.querySelectorAll(".enteral-details").forEach(d => d.removeAttribute("open"));
            }
        </script>
        <!-- スマホの初期で結果詳細を折りたたむ -->
        <script>
            if (window.matchMedia("(max-width: 980px)").matches) {
              document.querySelectorAll(".result-details").forEach(d => d.removeAttribute("open"));
            }
        </script>
</form>
