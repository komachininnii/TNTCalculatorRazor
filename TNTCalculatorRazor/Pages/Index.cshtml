@page
@model IndexModel
@using TNTCalculatorRazor.Domain.Enums

<form asp-action="Index" method="post" data-tnt-form="main">
    
    <input type="hidden" asp-for="Action" id="Action" />
    <input asp-for="IsProteinCorrectionUserEdited" type="hidden" id="IsProteinCorrectionUserEdited" />
    
    <div class="layout">
 
        <!-- ========================= -->
        <!-- 左：入力 -->
        <!-- ========================= -->
        <div class="main">
            <!-- スマホ初回のみ：ホーム画面追加の案内 -->
            <div id="homehint" class="homehint homehint--dismissible" style="display:none;">
                <div class="homehint-text">
                    スマホは「ホーム画面に追加」するとすぐ開けます。Androidでは「インストール」と表示される場合がありますが、オフライン対応などのアプリ化はしていません。
                </div>
                <button type="button" class="homehint-close" aria-label="閉じる">×</button>
            </div>

            <div class="card">
                <div class="section-head">
                    <h3>基本入力</h3>
                    <div class="section-meta">
                        （栄養：年齢･身長･体重･性別）/（推定CCr：年齢･体重･Cr･性別）
                    </div>
                </div>

                @if (((Model.Action ?? "").Trim().ToLowerInvariant()) == "anthro")
                {
                    <div class="validation-summary text-danger" asp-validation-summary="ModelOnly"></div>
                }

                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">年齢</div>
                        <div class="control">
                            <input asp-for="Age" type="number" step="1" inputmode="numeric"
                                   data-maxint="3" data-maxdec="0"
                                   data-enter-action="anthro"
                                   data-smart-blur="1" />
                            <span class="unit">歳</span>
                            @if (ViewData.ModelState.TryGetValue(nameof(Model.Age), out var entryAge)
                                && entryAge.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Age"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">身長</div>
                        <div class="control">
                            <input asp-for="Height" type="number" step="0.1" inputmode="decimal"
                                   data-maxint="3" data-maxdec="1"
                                   data-enter-action="anthro"
                                   data-smart-blur="1" />
                            <span class="unit">cm</span>

                            @if (ViewData.ModelState.TryGetValue(nameof(Model.Height), out var entryHeight)
                                && entryHeight.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Height"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">体重</div>
                        <div class="control">
                            <input asp-for="Weight" type="number" step="0.1" inputmode="decimal"
                                   data-maxint="3" data-maxdec="1"
                                   data-enter-action="anthro"
                                   data-smart-blur="1" />
                            <span class="unit">kg</span>

                            @if (ViewData.ModelState.TryGetValue(nameof(Model.Weight), out var entryWeight)
                                && entryWeight.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="Weight"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">Cr</div>
                        <div class="control">
                            <input asp-for="SerumCreatinine"
                                   type="number" step="0.01" inputmode="decimal"
                                   data-maxint="2" data-maxdec="2"
                                   data-change-action="renal"
                                   data-enter-action="renal"
                                   data-smart-blur="1" />
                            <span class="unit">mg/dL</span>
                            @if (ViewData.ModelState.TryGetValue(nameof(Model.SerumCreatinine), out var crEntry)
                                && crEntry.Errors.Count > 0)
                            {
                                <div class="field-error text-danger">
                                    <span asp-validation-for="SerumCreatinine"></span>
                                </div>
                            }
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">性別</div>
                        <div class="control">
                            <div class="inline-controls">
                                <select asp-for="Gender"
                                        asp-items="Html.GetEnumSelectList<GenderType>()"
                                        data-change-action="anthro">
                                </select>

                                @{
                                    bool showPregnant =
                                    Model.Gender == GenderType.Female
                                    && Model.Age.HasValue
                                    && Model.Age.Value >= 18
                                    && Model.Age.Value <= 55;
                                }

                                @if (showPregnant)
                                {
                                    <label class="inline-check"
                                           title="妊娠かつ肥満度120%以上では、水分計算に調整体重を使用します。">
                                        <input asp-for="IsPregnant"
                                               type="checkbox"
                                               data-change-action="anthro" />
                                        妊娠
                                    </label>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                @if (!(Model.Age.HasValue && Model.Age.Value < 18))
                {
                    <div class="field field-compact">
                        <div class="label">疾患</div>
                        <div class="control">
                            <select asp-for="SelectedDisease"
                                    asp-items="Html.GetEnumSelectList<DiseaseType>()"
                                    data-change-action="disease">
                            </select>
                        </div>
                    </div>
                }
            </div>

            <div class="card">
                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">活動係数</div>
                        <div class="control">
                            <select asp-for="ActivityFactor"
                                    asp-items="Html.GetEnumSelectList<ActivityFactorType>()"
                                    data-change-action="factors">
                            </select>
                        </div>
                    </div>
                    <div class="field field-compact">
                        <div class="label">ストレス係数</div>
                        <div class="control">
                            <select asp-for="StressFactor"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<StressFactorType>()"
                                    data-change-action="factors">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">体温補正</div>
                        <div class="control">
                            <select asp-for="SelectedBodyTemperature"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<BodyTemperatureLevel>()"
                                    data-change-action="factors">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">褥瘡</div>
                        <div class="control">
                            <select asp-for="SelectedPressureUlcer"
                                    class="sel-wide"
                                    asp-items="Html.GetEnumSelectList<PressureUlcerLevel>()"
                                    data-change-action="factors">
                            </select>
                        </div>
                    </div>

                    @if (Model.SelectedDisease == DiseaseType.LiverCirrhosis)
                    {
                        <div class="field sub">
                            <div class="label">肝性脳症</div>
                            <div class="control">
                                <label style="display:flex;gap:8px;align-items:center;">
                                    <input asp-for="IsHepaticEncephalopathy"
                                           type="checkbox"
                                           data-change-action="hepatic" />
                                    あり（蛋白不耐）
                                </label>
                                <span class="muted small">※ ONで蛋白補正 0.5 + 肝不全用アミノ酸製剤を検討</span>
                            </div>
                        </div>
                    }

                    <div class="field field-compact">
                        <div class="label">蛋白補正</div>
                        <div class="control">
                            <select asp-for="SelectedProteinCorrection"
                                    asp-items="Html.GetEnumSelectList<ProteinCorrectionType>()"
                                    data-change-action="protein">
                            </select>
                        </div>
                    </div>

                </div>
            </div>

            <div class="card card-energy">
                <h3>必要エネルギー</h3>

                <div class="fields">
                    <div class="field field-compact">
                        <div class="label">算出方法</div>
                        <div class="control">
                            <select asp-for="SelectedEnergyOrder"
                                    asp-items="Html.GetEnumSelectList<EnergyOrderType>()"
                                    data-change-action="order">
                            </select>
                        </div>
                    </div>

                    <div class="field field-compact">
                        <div class="label">必要エネルギー</div>
                        <div class="control">
                            <input asp-for="EnergyOrderValue"
                                   type="number" step="1" inputmode="numeric"
                                   data-maxint="4" data-maxdec="0"
                                   data-change-action="energy"
                                   data-enter-action="energy" />
                            <span class="unit">kcal/day</span>
                            @if (Model.IsEnergyUserEdited)
                            {
                                <span class="pill">手動編集</span>
                            }
                        </div>
                    </div>
                </div>

                <div class="hr"></div>
            
                <details class="fold energy-candidates">
                    <summary>エネルギー候補（参考）</summary>
                    <div class="small" style="margin-top:10px;">
                        <dl class="kv kv-2col-energy">
                            <dt>基礎代謝量×係数</dt>
                            <dd>@(Model.EnergyByBmrKcal?.ToString() ?? "-") kcal</dd>
                            <dt>25kcal/標準体重</dt>
                            <dd>@(Model.Kcal25?.ToString() ?? "-") kcal</dd>
                            <dt>30kcal/標準体重</dt>
                            <dd>@(Model.Kcal30?.ToString() ?? "-") kcal</dd>
                            <dt>35kcal/標準体重</dt>
                            <dd>@(Model.Kcal35?.ToString() ?? "-") kcal</dd>
                        </dl>
                    </div>
                </details>
            </div>
        </div>
        
        <!-- ========================= -->
        <!-- 右：結果 + 経腸 -->
        <!-- ========================= -->
        <div id="resultPanel">
            <partial name="_ResultPanel" />
        </div>
    </div>
</form>

